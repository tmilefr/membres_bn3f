<?php
defined('BASEPATH') || exit('No direct script access allowed');
		
use Dompdf\Dompdf;
use Dompdf\Options;

class Libpdf {
	
	var $CI;
	var $pdf_path = '';
	var $filename = '';
	
	/**
	 * Constructor of class element.
	 * @return void
	 */	
	public function __construct() {
		$this->CI = & get_instance();
		$this->_init();
		$this->pdf_path = str_replace('application','data/pdf',APPPATH);
		$this->img_path = str_replace('application','assets/img',APPPATH); //base_url().'assets/img/';
		$this->pdf_url_path = base_url().'data/pdf';
	}
	
	public function _init(){

		$_dompdf_show_warnings = true; // record warnings generated by Dompdf
		$_dompdf_debug = false; // output frame details for every frame in the document
		$_DOMPDF_DEBUG_TYPES = [
			'page-break' => false // record information about page break determination
		];

		$options = new Options();
		$options->set('logOutputFile','data/log.html');
		$options->set('enable_html5_parser',true);
		$options->set('_dompdf_debug',		false);
		$options->set("enable_remote", 		true);
		$options->setTempDir($this->pdf_path); 
		
		$pdf = new Dompdf($options);

		$pdf->setPaper('A4', 'portrait');

		$this->CI->dompdf = $pdf;
	}
	
	public function reset(){
		if (isset($this->CI->dompdf))
			unset($this->CI->dompdf);
		$this->_init();
	}

	function ImgBase64($img){
		$img = base64_encode(file_get_contents( $this->_get('img_path').$img));
		return '<img src="data:image/jpg;base64,'.$img.'" />';
	}

	//not sure that's good place for this ... need to do invoice lib
	/**
	 * @brief Pdf Create with $pdf data and view view
	 * @param $invoice 
	 * @returns void()
	 * 
	 * 
	 */
	function DoPdf($datas,$view_pdf,$filename){
		$data_view['datas'] = $datas;
		$data_view['logo'] =  $this->ImgBase64('bn3f.jpg');
		$html = $this->CI->load->view($view_pdf, $data_view, true);
		$this->filename = $filename;
		$this->makePdf($html);
	}
	
	/**
	 * @brief Create PDF File with Html content
	 * @param $html 
	 * @returns 
	 * 
	 * 
	 */
	function makePdf($html){

		try{
			$this->reset();
			file_put_contents($this->pdf_path.$this->filename."_raw.html", $html);
			//echo debug($html);

			$this->CI->dompdf->load_html($html);        
			$this->CI->dompdf->render();
			//$this->CI->dompdf->output(array('compress' => 0));
			/*$this->CI->dompdf->stream(
				$this->pdf_path.$this->filename,
				//array('compress' => 0) // disable PDF compression for easier PDF source inspection
			);*/
			//echo '<p>'.$this->pdf_path.$this->filename.'</p>';
			file_put_contents($this->pdf_path.$this->filename, $this->CI->dompdf->output()); 
		} catch (Exception $e) {
			echo 'Exception reÃ§ue : ',  $e->getMessage(), "\n";
		}
	}		
	
	/**
	 * Generic set
	 * @return void
	 */
	public function _set($field,$value){
		$this->$field = $value;
	}
	/**
	 * Generic get
	 * @return void
	 */
	public function _get($field){
		return $this->$field;
	}	
}
